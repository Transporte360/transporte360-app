{% extends "layouts/base.html" %}

{% block content %}

  <div class="card card-pad">
    <div class="row" style="justify-content:space-between; align-items:flex-end; gap:10px">
      <div>
        <div class="h2">Nuevo repostaje</div>
        <div class="tiny">Si dejas Importe vac√≠o, se calcula autom√°ticamente (litros √ó precio/L).</div>
      </div>
    </div>

    {% if error %}
      <div class="alert" style="margin-top:14px">
        <span>‚ö†Ô∏è</span>
        <div>
          <div style="font-weight:900">Error</div>
          <div class="tiny" style="color:#7f1d1d; opacity:.85">{{ error }}</div>
        </div>
      </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="grid g3" style="margin-top:14px">

      <div class="field">
        <div class="label">üìÖ Fecha</div>
        <input class="input" type="date" name="fecha" required style="padding-left:12px">
      </div>

      <div class="field">
        <div class="label">üß™ Tipo</div>
        <select class="input" name="tipo" style="padding-left:12px">
          <option value="gasoil" selected>Gasoil</option>
          <option value="adblue">AdBlue</option>
        </select>
      </div>

      <div class="field">
        <div class="label">üë∑ Chofer</div>
        <select class="input" name="conductor_id" style="padding-left:12px">
          <option value="">‚Äî</option>
          {% if conductores %}
            {% for c in conductores %}
              <option value="{{ c.id }}">{{ c.username }}</option>
            {% endfor %}
          {% endif %}
        </select>
      </div>

      <div class="field">
        <div class="label">‚õΩ Litros</div>
        <input class="input" type="number" step="0.01" name="litros" placeholder="Ej: 420.50" required style="padding-left:12px">
      </div>

      <div class="field">
        <div class="label">üí∂ Precio/L</div>
        <input class="input" type="number" step="0.001" name="precio_litro" placeholder="Ej: 1.389" required style="padding-left:12px">
      </div>

      <div class="field">
        <div class="label">üßæ Importe (‚Ç¨)</div>
        <input class="input" type="number" step="0.01" name="importe" placeholder="(vac√≠o = auto)" style="padding-left:12px">
      </div>

      <div class="field">
        <div class="label">üßæ KM od√≥metro</div>
        <input class="input" type="number" step="1" name="km_odometro" placeholder="Ej: 245120" style="padding-left:12px">
      </div>

      <div class="field">
        <div class="label">üèÅ Estaci√≥n</div>
        <input class="input" name="estacion" placeholder="Ej: Repsol A-2 km 312" style="padding-left:12px">
      </div>

      <div class="field">
        <div class="label">üìé Ticket</div>
        <input class="input" type="file" name="ticket_file" accept=".pdf,.jpg,.jpeg,.png" style="padding-left:12px">
      </div>

      <div class="field" style="display:flex; justify-content:flex-end">
        <button class="btn btn-primary" type="submit" style="width:100%">Guardar repostaje</button>
      </div>

    </form>
  </div>

  <div style="height:14px"></div>

  <div class="card card-pad">
    <div class="row" style="justify-content:space-between; align-items:center">
      <div class="h2">√öltimos repostajes</div>
      <div class="tiny">M√°x. 200</div>
    </div>

    <div style="overflow:auto; margin-top:10px">
      <table style="width:100%; border-collapse:collapse; background:#fff">
        <thead>
          <tr>
            <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)">Fecha</th>
            <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)">Tipo</th>
            <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)">Chofer</th>
            <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)">Estaci√≥n</th>
            <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border)">Litros</th>
            <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border)">‚Ç¨/L</th>
            <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border)">Importe</th>
            <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border)">KM</th>
            <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)">Ticket</th>
          </tr>
        </thead>
        <tbody>
          {% if rows and rows|length > 0 %}
            {% for r in rows %}
              <tr>
                <td style="padding:10px; border-bottom:1px solid var(--border)">{{ r.fecha }}</td>

                <td style="padding:10px; border-bottom:1px solid var(--border)">
                  <b>{{ (r.tipo or "gasoil")|capitalize }}</b>
                </td>

                <td style="padding:10px; border-bottom:1px solid var(--border)">
                  {% if r.conductor_id %}
                    <span class="tiny">ID {{ r.conductor_id }}</span>
                  {% else %}
                    <span class="muted">‚Äî</span>
                  {% endif %}
                </td>

                <td style="padding:10px; border-bottom:1px solid var(--border)">
                  {% if r.estacion %}{{ r.estacion }}{% else %}<span class="muted">‚Äî</span>{% endif %}
                </td>

                <td style="padding:10px; border-bottom:1px solid var(--border); text-align:right">
                  {{ "%.2f"|format(r.litros) }}
                </td>

                <td style="padding:10px; border-bottom:1px solid var(--border); text-align:right">
                  {{ "%.3f"|format(r.precio_litro) }}
                  {% if r.precio_calc %}
                    <div class="tiny muted">calc: {{ "%.3f"|format(r.precio_calc) }}</div>
                  {% endif %}
                </td>

                <td style="padding:10px; border-bottom:1px solid var(--border); text-align:right">
                  <b>{{ "%.2f"|format(r.importe) }}‚Ç¨</b>
                </td>

                <td style="padding:10px; border-bottom:1px solid var(--border); text-align:right">
                  {% if r.km_odometro is not none %}
                    {{ "%.0f"|format(r.km_odometro) }}
                  {% else %}
                    <span class="muted">‚Äî</span>
                  {% endif %}
                </td>

                <td style="padding:10px; border-bottom:1px solid var(--border)">
                  {% if r.ticket_path %}
                    <a href="{{ url_for('serve_upload', subpath=r.ticket_path) }}" target="_blank">Ver</a>
                  {% else %}
                    <span class="muted">‚Äî</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="9" class="muted" style="padding:12px">Sin repostajes a√∫n.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

{% endblock %}

