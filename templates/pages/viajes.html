{% extends "layouts/base.html" %}

{% block content %}

  <div class="card card-pad">
    <div class="h2">Nuevo viaje</div>
    <div class="tiny">Si dejas KM inicio vacÃ­o, se usa el Ãºltimo KM fin del mismo camiÃ³n.</div>

    {% if error %}
      <div class="alert" style="margin-top:14px">
        <span>âš ï¸</span>
        <div>
          <div style="font-weight:900">Error</div>
          <div class="tiny" style="color:#7f1d1d; opacity:.85">{{ error }}</div>
        </div>
      </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="grid g3" style="margin-top:14px">

      <div class="field">
        <div class="label">ğŸ“… Fecha</div>
        <input class="input" type="date" name="fecha" required style="padding-left:12px">
      </div>

      <div class="field">
        <div class="label">ğŸšš MatrÃ­cula</div>
        <input class="input" name="camion_matricula" placeholder="1234ABC" required style="padding-left:12px; text-transform:uppercase">
      </div>

      <div class="field">
        <div class="label">âš–ï¸ Peso (kg)</div>
        <input class="input" type="number" step="1" name="peso_kg" placeholder="24000" style="padding-left:12px">
      </div>

      <div class="field">
        <div class="label">ğŸ“ Origen</div>
        <input class="input" name="origen" placeholder="Barcelona" required style="padding-left:12px">
      </div>

      <div class="field">
        <div class="label">ğŸ“ Destino</div>
        <input class="input" name="destino" placeholder="Vitoria" required style="padding-left:12px">
      </div>

      <div class="field">
        <div class="label">ğŸ“ CMR</div>
        <input class="input" type="file" name="cmr_file" accept=".pdf,.jpg,.jpeg,.png" style="padding-left:12px">
      </div>

      <div class="field">
        <div class="label">ğŸ§¾ KM inicio</div>
        <input class="input" type="number" step="1" name="km_inicio" placeholder="(vacÃ­o = auto)" style="padding-left:12px">
      </div>

      <div class="field">
        <div class="label">ğŸ§¾ KM fin</div>
        <input class="input" type="number" step="1" name="km_fin" placeholder="Ej: 245000" required style="padding-left:12px">
      </div>

      <div class="field" style="display:flex; justify-content:flex-end">
        <button class="btn btn-primary" type="submit" style="width:100%">Guardar viaje</button>
      </div>

    </form>
  </div>

  <div style="height:14px"></div>

  <div class="card card-pad">
    <div class="row" style="justify-content:space-between; align-items:center">
      <div class="h2">Ãšltimos viajes</div>
      <div class="tiny">MÃ¡x. 200</div>
    </div>

    <div style="overflow:auto; margin-top:10px">
      <table style="width:100%; border-collapse:collapse; background:#fff">
        <thead>
          <tr>
            <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)">Fecha</th>
            <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)">CamiÃ³n</th>
            <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)">Origen â†’ Destino</th>
            <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border)">KM</th>
            <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)">CMR</th>
            <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)">Creado por</th>
          </tr>
        </thead>
        <tbody>
          {% if rows and rows|length > 0 %}
            {% for r in rows %}
              <tr>
                <td style="padding:10px; border-bottom:1px solid var(--border)">{{ r.fecha }}</td>
                <td style="padding:10px; border-bottom:1px solid var(--border)"><b>{{ r.camion_matricula }}</b></td>
                <td style="padding:10px; border-bottom:1px solid var(--border)">{{ r.origen }} â†’ {{ r.destino }}</td>
                <td style="padding:10px; border-bottom:1px solid var(--border); text-align:right">
                  <b>{{ "%.0f"|format(r.km_total) }}</b>
                  <div class="tiny">{{ "%.0f"|format(r.km_inicio) }} â†’ {{ "%.0f"|format(r.km_fin) }}</div>
                </td>
                <td style="padding:10px; border-bottom:1px solid var(--border)">
                  {% if r.cmr_path %}
                    <a href="{{ url_for('serve_upload', subpath=r.cmr_path) }}" target="_blank">Ver CMR</a>
                  {% else %} â€” {% endif %}
                </td>
                <td style="padding:10px; border-bottom:1px solid var(--border)">{{ r.created_by }} <span class="tiny">({{ r.created_role }})</span></td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="6" class="muted" style="padding:12px">Sin viajes aÃºn.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

{% endblock %}
