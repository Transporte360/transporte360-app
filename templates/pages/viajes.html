{% extends "layouts/base.html" %}

{% block content %}

  <div class="card card-pad">
    <div class="row" style="justify-content:space-between; align-items:flex-start; flex-wrap:wrap">
      <div class="col" style="gap:6px">
        <div class="h2">Nuevo viaje</div>
        <div class="tiny">KM inicio se autocompleta con el √∫ltimo KM fin del mismo cami√≥n (si lo dejas vac√≠o).</div>
      </div>

      <form method="get" action="{{ url_for('viajes') }}" class="row" style="gap:10px">
        <input class="input" name="m" placeholder="Buscar por matr√≠cula (opcional)" value="{{ matricula_query or '' }}" style="max-width:260px; padding-left:12px">
        <button class="btn btn-ghost" type="submit">Ver √∫ltimo KM</button>
      </form>
    </div>

    {% if suggested_km_inicio is not none and matricula_query %}
      <div class="pill" style="margin-top:10px">
        √öltimo KM fin para <b>{{ matricula_query }}</b>: <b>{{ "%.0f"|format(suggested_km_inicio) }}</b>
      </div>
    {% endif %}

    {% if error %}
      <div class="alert" style="margin-top:14px">
        <span>‚ö†Ô∏è</span>
        <div>
          <div style="font-weight:900">Error</div>
          <div class="tiny" style="color:#7f1d1d; opacity:.85">{{ error }}</div>
        </div>
      </div>
    {% endif %}

    <form method="post" action="{{ url_for('viajes') }}" enctype="multipart/form-data" class="grid g3" style="margin-top:14px">

      <div class="field">
        <div class="label">üìÖ Fecha</div>
        <input class="input" type="date" name="fecha" required style="padding-left:12px">
      </div>

      <div class="field">
        <div class="label">üöö Matr√≠cula (cami√≥n)</div>
        <input class="input" name="camion_matricula" placeholder="1234ABC" required style="padding-left:12px; text-transform:uppercase">
      </div>

      <div class="field">
        <div class="label">‚öñÔ∏è Peso (kg)</div>
        <input class="input" type="number" step="1" name="peso_kg" placeholder="24000" style="padding-left:12px">
      </div>

      <div class="field">
        <div class="label">üìç Origen</div>
        <input class="input" name="origen" placeholder="Barcelona" required style="padding-left:12px">
      </div>

      <div class="field">
        <div class="label">üìç Destino</div>
        <input class="input" name="destino" placeholder="Vitoria" required style="padding-left:12px">
      </div>

      <div class="field">
        <div class="label">üìé CMR (PDF/JPG/PNG)</div>
        <input class="input" type="file" name="cmr_file" accept=".pdf,.jpg,.jpeg,.png" style="padding-left:12px">
        <div class="tiny">Si quieres que sea obligatorio, lo hacemos en el siguiente ajuste.</div>
      </div>

      <div class="field">
        <div class="label">üßæ KM inicio (od√≥metro)</div>
        <input class="input" type="number" step="1" name="km_inicio" placeholder="(vac√≠o = auto)" style="padding-left:12px">
        <div class="tiny">Auto = √∫ltimo KM fin del cami√≥n. Si no hay historial, usa 0.</div>
      </div>

      <div class="field">
        <div class="label">üßæ KM fin (od√≥metro)</div>
        <input class="input" type="number" step="1" name="km_fin" placeholder="Ej: 245000" required style="padding-left:12px">
      </div>

      <div class="field" style="display:flex; justify-content:flex-end">
        <button class="btn btn-primary" type="submit" style="width:100%">Guardar viaje</button>
      </div>

    </form>
  </div>

  <div style="height:14px"></div>

  <div class="card card-pad">
    <div class="row" style="justify-content:space-between; align-items:center">
      <div class="h2">√öltimos viajes</div>
      <div class="tiny">M√°x. 200</div>
    </div>

    <div style="overflow:auto; margin-top:10px">
      <table style="width:100%; border-collapse:collapse; background:#fff">
        <thead>
          <tr>
            <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)">Fecha</th>
            <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)">Cami√≥n</th>
            <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)">Origen ‚Üí Destino</th>
            <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border)">KM</th>
            <th style="text-align:right; padding:10px; border-bottom:1px solid var(--border)">Peso</th>
            <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)">CMR</th>
            <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)">Creado por</th>
          </tr>
        </thead>
        <tbody>
          {% if rows and rows|length > 0 %}
            {% for r in rows %}
              <tr>
                <td style="padding:10px; border-bottom:1px solid var(--border)">{{ r.fecha }}</td>
                <td style="padding:10px; border-bottom:1px solid var(--border)"><b>{{ r.camion_matricula }}</b></td>
                <td style="padding:10px; border-bottom:1px solid var(--border)">
                  {{ r.origen }} ‚Üí {{ r.destino }}
                </td>
                <td style="padding:10px; border-bottom:1px solid var(--border); text-align:right">
                  <b>{{ "%.0f"|format(r.km_total) }}</b>
                  <div class="tiny">{{ "%.0f"|format(r.km_inicio) }} ‚Üí {{ "%.0f"|format(r.km_fin) }}</div>
                </td>
                <td style="padding:10px; border-bottom:1px solid var(--border); text-align:right">
                  {{ "%.0f"|format(r.peso_kg or 0) }}
                </td>
                <td style="padding:10px; border-bottom:1px solid var(--border)">
                  {% if r.cmr_path %}
                    <a href="{{ url_for('serve_upload', subpath=r.cmr_path) }}" target="_blank">Ver CMR</a>
                  {% else %}
                    ‚Äî
                  {% endif %}
                </td>
                <td style="padding:10px; border-bottom:1px solid var(--border)">
                  {{ r.created_by }}
                  <span class="tiny">({{ r.created_role }})</span>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="7" class="muted" style="padding:12px">Sin viajes a√∫n.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

{% endblock %}
