{% extends "layouts/base.html" %}
{% set title = "Transporte360 - TMS" %}

{% block content %}

<section id="viewApp">
  <div class="app-shell">

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M4 12l8-6 8 6" stroke="#E67E22" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M7 12v8h10v-8" stroke="#fff" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="col" style="gap:4px">
          <div style="font-weight:900; font-size:16px; line-height:1">Transporte360</div>
          <div class="badge">TMS ¬∑ Operaciones</div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="tiny" style="color:rgba(255,255,255,.72); padding:0 6px">
        Usuario: <span id="userName" style="color:#fff; font-weight:900">{{ user.name }}</span><br/>
        Rol: <span id="userRole" style="color:#fff; font-weight:900">{{ user.role }}</span>
      </div>

      <div class="nav" id="nav">
        <!-- Siempre visible -->
        <a href="#" data-screen="dashboard" class="active">
          <span class="nav-ic">üìä</span> Dashboard
        </a>

        <a href="#" data-screen="trips">
          <span class="nav-ic">üßæ</span> Viajes
        </a>

        <a href="#" data-screen="fuel">
          <span class="nav-ic">‚õΩ</span> Repostajes
        </a>

        <a href="#" data-screen="docs">
          <span class="nav-ic">üìé</span> Documentos
        </a>

        <!-- Solo MANAGER -->
        {% if user.role == "manager" %}
        <a href="#" data-screen="drivers">
          <span class="nav-ic">üë∑</span> Conductores
        </a>

        <a href="#" data-screen="vehicles">
          <span class="nav-ic">üöö</span> Veh√≠culos
        </a>

        <a href="#" data-screen="settings">
          <span class="nav-ic">‚öôÔ∏è</span> Ajustes
        </a>
        {% endif %}

        <div style="height:10px"></div>

        <a href="/logout" id="logoutBtn">
          <span class="nav-ic">üö™</span> Salir
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="content">
      <div class="topbar">
        <div class="col" style="gap:2px">
          <div class="h1" id="screenTitle">Panel de Gesti√≥n</div>
          <div class="muted" id="screenSubtitle">Resumen mensual de operaciones ‚Äî Enero 2026</div>
        </div>

        <div class="right">
          <div class="pill">
            <span class="tiny">Estado:</span>
            <span class="chip up">Operativo</span>
          </div>
          <button class="btn btn-primary" type="button" id="addActionBtn">+ Nueva acci√≥n</button>
        </div>
      </div>

      <!-- DASHBOARD -->
      <section id="screen-dashboard" class="col" style="gap:14px">

        <div class="grid g4">
          <div class="stat">
            <div class="row" style="justify-content:space-between">
              <div class="h2">Kil√≥metros Totales</div>
              <span class="chip up">+12.5%</span>
            </div>
            <div class="kpi">45.280</div>
            <div class="tiny">Tendencia positiva vs mes anterior</div>
          </div>

          <div class="stat">
            <div class="row" style="justify-content:space-between">
              <div class="h2">Kil√≥metros Vac√≠os</div>
              <span class="chip down">18.2%</span>
            </div>
            <div class="kpi">8.241</div>
            <div class="tiny">Tendencia negativa -3.1% vs objetivo</div>
          </div>

          <div class="stat">
            <div class="row" style="justify-content:space-between">
              <div class="h2">Ingresos Totales</div>
              <span class="chip up">+8.7%</span>
            </div>
            <div class="kpi">‚Ç¨54.336</div>
            <div class="tiny">Tendencia positiva vs mes anterior</div>
          </div>

          <div class="stat">
            <div class="row" style="justify-content:space-between">
              <div class="h2">Beneficio Neto</div>
              <span class="chip up">+15.3%</span>
            </div>
            <div class="kpi">‚Ç¨12.847</div>
            <div class="tiny">Margen: <b>23.6%</b></div>
          </div>
        </div>

        <div class="grid g3">
          <div class="card card-pad">
            <div class="row" style="justify-content:space-between">
              <div class="h2">Costes Variables</div>
              <span class="chip">‚Ç¨18.560</span>
            </div>
            <div class="tiny" style="margin-top:6px">Combustible <b>‚Ç¨12.340</b> ¬∑ Peajes <b>‚Ç¨4.520</b> ¬∑ Otros <b>‚Ç¨1.700</b></div>
            <div class="chart-area" style="margin-top:12px; height:140px">placeholder gr√°fico variables</div>
          </div>

          <div class="card card-pad">
            <div class="row" style="justify-content:space-between">
              <div class="h2">Combustible Real</div>
              <span class="chip">‚Ç¨12.340</span>
            </div>
            <div class="tiny" style="margin-top:6px">Litros totales <b>8,227 L</b> ¬∑ Precio medio <b>‚Ç¨1.50/L</b> ¬∑ Consumo <b>18.2 L/100km</b></div>
            <div class="chart-area" style="margin-top:12px; height:140px">placeholder gr√°fico combustible</div>
          </div>

          <div class="card card-pad">
            <div class="row" style="justify-content:space-between">
              <div class="h2">Costes Fijos Asignados</div>
              <span class="chip">‚Ç¨10.589</span>
            </div>
            <div class="tiny" style="margin-top:6px">Seguros <b>‚Ç¨4.200</b> ¬∑ Mantenimiento <b>‚Ç¨3.890</b> ¬∑ Otros <b>‚Ç¨2.499</b></div>
            <div class="chart-area" style="margin-top:12px; height:140px">placeholder gr√°fico fijos</div>
          </div>
        </div>

        <div class="grid g2">
          <div class="chart">
            <div class="row" style="justify-content:space-between">
              <div class="h2">Tendencia Mensual</div>
              <span class="tiny">Ingresos vs Costes</span>
            </div>
            <div class="chart-area">placeholder chart line/bar</div>
          </div>

          <div class="chart">
            <div class="row" style="justify-content:space-between">
              <div class="h2">Distribuci√≥n de Viajes</div>
              <span class="tiny">Total: <b>142</b></span>
            </div>
            <div class="chart-area">placeholder donut / pie</div>
            <div class="row" style="justify-content:space-between">
              <span class="tiny"><b>81.8%</b> Cargados (116)</span>
              <span class="tiny"><b>18.2%</b> Vac√≠os (26)</span>
            </div>
          </div>
        </div>

        <div class="card card-pad">
          <div class="row" style="justify-content:space-between; margin-bottom:10px">
            <div class="h2">Actividad Reciente</div>
            <span class="tiny">Hoy</span>
          </div>

          <div class="grid g2">
            <div class="card card-pad" style="box-shadow:none; background:#fbfdff">
              <div class="row" style="justify-content:space-between">
                <div style="font-weight:900">Miguel Fern√°ndez</div>
                <span class="chip up">Cargado</span>
              </div>
              <div class="tiny">ABC-1234 ¬∑ 15/01/2026</div>
              <div class="row" style="justify-content:space-between; margin-top:8px">
                <div style="font-weight:800; color:var(--primary)">Madrid ‚Üí Barcelona</div>
                <div class="tiny">628 km</div>
              </div>
              <div class="row" style="justify-content:space-between; margin-top:6px">
                <div class="tiny">Ingresos</div>
                <div style="font-weight:900">‚Ç¨753.60</div>
              </div>
            </div>

            <div class="card card-pad" style="box-shadow:none; background:#fbfdff">
              <div class="row" style="justify-content:space-between">
                <div style="font-weight:900">Ana Mart√≠nez</div>
                <span class="chip down">Vac√≠o</span>
              </div>
              <div class="tiny">XYZ-5678 ¬∑ 15/01/2026</div>
              <div class="row" style="justify-content:space-between; margin-top:8px">
                <div style="font-weight:800; color:var(--primary)">Valencia ‚Üí Sevilla</div>
                <div class="tiny">‚Äî km</div>
              </div>
              <div class="row" style="justify-content:space-between; margin-top:6px">
                <div class="tiny">Ingresos</div>
                <div style="font-weight:900">‚Ç¨0.00</div>
              </div>
            </div>
          </div>
        </div>

      </section>

      <!-- OTHER SCREENS -->
      <section id="screen-trips" class="hidden">
        <div class="card card-pad">
          <div class="h2">Viajes</div>
          <div class="muted">Aqu√≠ va tu tabla/l√≥gica real.</div>
        </div>
      </section>

      <section id="screen-fuel" class="hidden">
        <div class="card card-pad">
          <div class="h2">Repostajes</div>
          <div class="muted">Aqu√≠ metes tu secci√≥n de repostajes.</div>
        </div>
      </section>

      {% if user.role == "manager" %}
      <section id="screen-drivers" class="hidden">
        <div class="card card-pad">
          <div class="h2">Conductores</div>
          <div class="muted">Listado + alta/edici√≥n.</div>
        </div>
      </section>

      <section id="screen-vehicles" class="hidden">
        <div class="card card-pad">
          <div class="h2">Veh√≠culos</div>
          <div class="muted">Ficha del cami√≥n, ITV, seguro, etc.</div>
        </div>
      </section>

      <section id="screen-settings" class="hidden">
        <div class="card card-pad">
          <div class="h2">Ajustes</div>
          <div class="muted">Roles, usuarios, par√°metros, etc.</div>
        </div>
      </section>
      {% endif %}

      <section id="screen-docs" class="hidden">
        <div class="card card-pad">
          <div class="h2">Documentos</div>
          <div class="muted">CMR, facturas, recibos‚Ä¶</div>
        </div>
      </section>

    </main>
  </div>
</section>

<script>
  const USER_ROLE = "{{ user.role }}";

  const nav = document.getElementById("nav");
  const screenTitle = document.getElementById("screenTitle");
  const screenSubtitle = document.getElementById("screenSubtitle");
  const addActionBtn = document.getElementById("addActionBtn");

  function setActiveNav(screen){
    [...nav.querySelectorAll("a[data-screen]")].forEach(a => {
      a.classList.toggle("active", a.dataset.screen === screen);
    });
  }

  function switchScreen(screen){
    const screens = (USER_ROLE === "manager")
      ? ["dashboard","trips","fuel","drivers","vehicles","docs","settings"]
      : ["dashboard","trips","fuel","docs"];

    screens.forEach(s => {
      const el = document.getElementById("screen-" + s);
      if(!el) return;
      el.classList.toggle("hidden", s !== screen);
    });

    if(screen === "dashboard"){
      screenTitle.textContent = "Panel de Gesti√≥n";
      screenSubtitle.textContent = "Resumen mensual de operaciones ‚Äî Enero 2026";
    } else {
      const titles = {
        trips:"Viajes",
        fuel:"Repostajes",
        drivers:"Conductores",
        vehicles:"Veh√≠culos",
        docs:"Documentos",
        settings:"Ajustes"
      };
      screenTitle.textContent = titles[screen] || "Secci√≥n";
      screenSubtitle.textContent = "Transporte360 ‚Äî Operaciones";
    }
  }

  nav.addEventListener("click", (e) => {
    const a = e.target.closest("a[data-screen]");
    if(!a) return;
    e.preventDefault();
    const screen = a.dataset.screen;

    // Seguridad UI: driver no puede abrir pantallas de manager
    if(USER_ROLE !== "manager" && ["drivers","vehicles","settings"].includes(screen)){
      return;
    }

    setActiveNav(screen);
    switchScreen(screen);
  });

  addActionBtn?.addEventListener("click", () => {
    alert("Aqu√≠ conectas tu l√≥gica: nuevo viaje / nuevo repostaje / etc.");
  });

  // Arranque: dashboard
  setActiveNav("dashboard");
  switchScreen("dashboard");
</script>

{% endblock %}

